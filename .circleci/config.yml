version: 2.1

jobs:
  test:
    docker:
      - image: shaguarger/platformio
    steps:
      - checkout
      - run:
          command: |
            echo << pipeline.git.tag >>
            cd control-panel
            platformio check --skip-packages --environment megaatmega2560
  build:
    docker:
      - image: shaguarger/platformio
    steps:
      - checkout
      - run:
          command: |
            cd control-panel
            platformio run --environment megaatmega2560
      - store_artifacts:
          path: control-panel/.pio/build/megaatmega2560/firmware.elf
          destination: ./artifacts/firmware.elf
      - store_artifacts:
          path: control-panel/.pio/build/megaatmega2560/firmware.hex
          destination: ./artifacts/firmware.hex
  release:
    docker:
      - image: cimg/base:2022.06
    parameters:
      version_tag:
        type: string
        description: Version tag of this release.
    steps:
      - setup_remote_docker:
          version: 20.10.14
      - attach_workspace:
          at: ./artifacts
      - run:
          name: "Publish Release on GitHub"
          command: |
            docker run -it -e GITHUB_TOKEN=${GITHUB_TOKEN} maniator/gh:v2.20.0 "gh release create ${version_tag} ./artifacts/ -t ${CIRCLE_PROJECT_REPONAME}"

workflows:
  dev:
    jobs:
      - test
      - build:
          requires:
            - test
  prod:
    when:
      equal: [ /^\d+\.\d+\.\d+$/, << pipeline.git.tag >> ]
    jobs:
      - test
      - build:
          requires:
            - test
      - release:
          requires:
            - build
          version_tag: << pipeline.git.tag >>
